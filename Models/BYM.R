# Theo AO Rashid -- March 2020

# ----- BYM model -----
# Common terms (normal prior) +
# BYM for each LSOA +
# Age effects (random walk prior)
# --------------------

library(rgdal)
library(spdep)
library(RCurl)
library(dplyr)
library(nimble)
library(igraph)

set.seed(1)

# ----- IMPORT DATA -----
# Mortality data
# url <- getURL("https://media.githubusercontent.com/media/theorashid/mortality-statsmodel/master/Data/mortsim.csv") # London
url <- getURL("https://media.githubusercontent.com/media/theorashid/mortality-statsmodel/master/Data/mortsim_hf.csv") # Hammersmith and Fulham
mortality <- read.csv(text = url) %>%
  select(-X) # remove autogenerated column

mortality_m <- mortality %>% # Select male sex
  filter(sex == 1) %>%
  select(-sex)

# Lookup table
grid.lookup <- mortality_m %>% # lookup correct MSOA or LAD for that LSOA
  select(LSOA.id, MSOA.id, LAD.id) %>%
  distinct() %>%
  arrange(LSOA.id) # arrange ascending so matches loop order
grid.lookup <- as.matrix(grid.lookup) # grid.lookup[j, 2] for MSOA, grid.lookup[j, 3] for LAD

# Shape data
test <- readOGR(dsn = "Data/shapefiles/ldn_LSOA11",
                layer = "LSOA11_London")
# Merge with mortality

# test1 = subset(test, code=="HF") # load for hammersmith and fulham

# Extract adjacency matrix
W.nb <- poly2nb(test, row.names =  rownames(test@data))
nbInfo <- nb2WB(W.nb)
# nbInfo$adj
# adj = nbInfo$adj, weights = nbInfo$weights, num = nbInfo$num
# s[1:N] ~ dcar_normal(adj[1:L], weights[1:L], num[1:N], tau, zero_mean = 0)

# Dimensions (Hammersmith and Fulham unit test second value):
# - age -- 19 (0, 1-4, 5-10, ..., 80-84, 85+)
# - LAD -- 33 or 1
# - MSOA -- 983 or 25
# - LSOA -- 4835 or 113
# - YEAR -- 14 (2004-17)

# BYM - u structured CAR effect, v unstructured
# N is number of spatial units
# L is the length of the adjacency matrix
u[1:N] ~ dcar_normal(adj[1:L], weights[1:L], num[1:N], tau_u, zero_mean = 0)
for (j in 1:N) {
    tmp[j] <- alpha + u[j]
    v[j] ~ dnorm(tmp[j], tau_v)
}
sigma_u ~ dunif(0,2)
tau_u <- pow(sigma_u,-2)
sigma_v ~ dunif(0,2)
tau_v <- pow(sigma_v,-2)
